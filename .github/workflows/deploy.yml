name: Real-time Auto Deployment (Self-hosted)

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate .env file
        env:
          JSON_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET_JSON }}
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}" >> .env
          echo "TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}" >> .env
          echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> .env
          
          echo "YOUTUBE_CLIENT_SECRET_JSON_B64=$(echo -n "$JSON_SECRET" | base64 -w 0)" >> .env
          
          # Inject Channel Specific Secrets into .env for Docker Compose consumption
          echo "SECRET_SCIENCE=${{ secrets.YOUTUBE_CLIENT_SECRET_SCIENCE }}" >> .env
          echo "SECRET_HORROR=${{ secrets.YOUTUBE_CLIENT_SECRET_HORROR }}" >> .env
          echo "SECRET_STOCKS=${{ secrets.YOUTUBE_CLIENT_SECRET_STOCKS }}" >> .env
          echo "SECRET_HISTORY=${{ secrets.YOUTUBE_CLIENT_SECRET_HISTORY }}" >> .env

      - name: Deploy to Docker Compose
        run: |
          # Clean up old images
          docker image prune -f
          
          # Start services with forced recreation to ensure new builds are used
          docker-compose up -d --build --force-recreate ai-media-service mongo zookeeper kafka shorts-science shorts-horror shorts-stocks shorts-history shorts-renderer shorts-log-service frontend-server tailscale
