name: Real-time Auto Deployment (Self-hosted)

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate .env file
        env:
          JSON_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET_JSON }}
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}" >> .env
          echo "TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}" >> .env
          echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> .env
          
          echo "YOUTUBE_CLIENT_SECRET_JSON_B64=$(echo -n "$JSON_SECRET" | base64 -w 0)" >> .env

          # Remove existing directory to preventing 'Is a directory' error if Docker created it wrongly
          rm -rf backend/client_secret
          
          # Create Client Secret Directories
          mkdir -p backend/client_secret/SciencePixel
          mkdir -p backend/client_secret/MysteryPixel
          mkdir -p backend/client_secret/ValuePixel
          mkdir -p backend/client_secret/MemoryPixel

          # Generate Client Secret Files from Secrets
          echo "${{ secrets.YOUTUBE_CLIENT_SECRET_SCIENCE }}" > backend/client_secret/SciencePixel/client_secret.json
          echo "${{ secrets.YOUTUBE_CLIENT_SECRET_HORROR }}" > backend/client_secret/MysteryPixel/client_secret.json
          echo "${{ secrets.YOUTUBE_CLIENT_SECRET_STOCKS }}" > backend/client_secret/ValuePixel/client_secret.json
          echo "${{ secrets.YOUTUBE_CLIENT_SECRET_HISTORY }}" > backend/client_secret/MemoryPixel/client_secret.json

      - name: Deploy to Docker Compose
        run: |
          # Clean up old images
          docker image prune -f
          
          # Start services with forced recreation to ensure new builds are used
          docker-compose up -d --build --force-recreate ai-media-service mongo zookeeper kafka shorts-science shorts-horror shorts-stocks shorts-history shorts-renderer shorts-log-service frontend-server tailscale
