name: Real-time Auto Deployment (Self-hosted)

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate .env file
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}" >> .env
          echo "TAILSCALE_AUTHKEY=${{ secrets.TAILSCALE_AUTHKEY }}" >> .env
          echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> .env
          echo "YOUTUBE_CLIENT_SECRET_JSON='${{ secrets.YOUTUBE_CLIENT_SECRET_JSON }}'" >> .env

      - name: Deploy to Docker Compose
        run: |
          # Clean up old images
          docker image prune -f
          
          # Start services with forced recreation to ensure new builds are used
          docker-compose up -d --build --force-recreate ai-media-service mongo shorts-controller shorts-log-service frontend-server tailscale zookeeper kafka
