services:
  # ---------------------------------------------------------------------------
  # 1. DATABASE (Isolated V2)
  # ---------------------------------------------------------------------------
  mongo-v2:
    image: mongo:latest
    container_name: mongo-v2
    restart: always
    ports:
      - "27018:27017" # Exposed for debugging, can be removed for strict isolation
    environment:
      MONGO_INITDB_DATABASE: science-shorts-db
    volumes:
      - mongo-data-v2:/data/db
    networks:
      - shorts-network-v2

  # ---------------------------------------------------------------------------
  # 2. MESSAGE BROKER (Isolated V2 - Internal Only)
  # ---------------------------------------------------------------------------
  zookeeper-v2:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper-v2
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - shorts-network-v2

  kafka-v2:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka-v2
    depends_on:
      - zookeeper-v2
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-v2:2181
      # Internal listener only
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-v2:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    networks:
      - shorts-network-v2

  # ---------------------------------------------------------------------------
  # 3. BACKEND CONTROLLERS (Producer / Planner)
  # ---------------------------------------------------------------------------
  shorts-science-v2:
    build:
      context: ./backend
      dockerfile: shorts-api/Dockerfile
    image: shorts-api-v2:latest
    container_name: shorts-science-v2
    env_file:
      - .env
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo-v2:27017/science-shorts-db
      - SHORTS_CHANNEL_ID=science
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-v2:9092
      - SERVER_PORT=8080
      - ENABLE_SCHEDULING=false
      - APP_FEATURE_REMOTE_RENDERING=true
      - APP_FEATURE_CONSUMER_SCRIPT=true
      - APP_FEATURE_CONSUMER_SCENE=false
      - APP_FEATURE_CONSUMER_RENDER=false
    volumes:
      - ./backend/client_secret:/app/client_secret
      - ./backend/tokens:/app/tokens
      - shorts-data-v2:/app/shared-data
    networks:
      - shorts-network-v2
    depends_on:
      - mongo-v2
      - kafka-v2

  shorts-horror-v2:
    image: science-pixel-controller-v2:latest
    container_name: shorts-horror-v2
    env_file:
      - .env
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo-v2:27017/science-shorts-db
      - SHORTS_CHANNEL_ID=horror
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-v2:9092
      - SERVER_PORT=8080
      - ENABLE_SCHEDULING=false
      - APP_FEATURE_REMOTE_RENDERING=true
      - APP_FEATURE_CONSUMER_SCRIPT=true
      - APP_FEATURE_CONSUMER_SCENE=false
      - APP_FEATURE_CONSUMER_RENDER=false
    volumes:
      - ./backend/client_secret:/app/client_secret
      - ./backend/tokens:/app/tokens
      - shorts-data-v2:/app/shared-data
    networks:
      - shorts-network-v2
    depends_on:
      - mongo-v2
      - kafka-v2

  shorts-stocks-v2:
    image: science-pixel-controller-v2:latest
    container_name: shorts-stocks-v2
    env_file:
      - .env
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo-v2:27017/science-shorts-db
      - SHORTS_CHANNEL_ID=stocks
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-v2:9092
      - SERVER_PORT=8080
      - ENABLE_SCHEDULING=false
      - APP_FEATURE_REMOTE_RENDERING=true
      - APP_FEATURE_CONSUMER_SCRIPT=true
      - APP_FEATURE_CONSUMER_SCENE=false
      - APP_FEATURE_CONSUMER_RENDER=false
    volumes:
      - ./backend/client_secret:/app/client_secret
      - ./backend/tokens:/app/tokens
      - shorts-data-v2:/app/shared-data
    networks:
      - shorts-network-v2
    depends_on:
      - mongo-v2
      - kafka-v2

  shorts-history-v2:
    image: science-pixel-controller-v2:latest
    container_name: shorts-history-v2
    env_file:
      - .env
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo-v2:27017/science-shorts-db
      - SHORTS_CHANNEL_ID=history
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-v2:9092
      - SERVER_PORT=8080
      - ENABLE_SCHEDULING=false
      - APP_FEATURE_REMOTE_RENDERING=true
      - APP_FEATURE_CONSUMER_SCRIPT=true
      - APP_FEATURE_CONSUMER_SCENE=false
      - APP_FEATURE_CONSUMER_RENDER=false
    volumes:
      - ./backend/client_secret:/app/client_secret
      - ./backend/tokens:/app/tokens
      - shorts-data-v2:/app/shared-data
    networks:
      - shorts-network-v2
    depends_on:
      - mongo-v2
      - kafka-v2

  # ---------------------------------------------------------------------------
  # 4. RENDERER WORKER (Kotlin Consumer)
  # ---------------------------------------------------------------------------
  shorts-renderer-v2:
    build:
      context: ./backend
      dockerfile: shorts-worker/Dockerfile
    image: shorts-worker-v2:latest
    container_name: shorts-renderer-v2
    env_file:
      - .env
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo-v2:27017/science-shorts-db
      - SHORTS_CHANNEL_ID=renderer
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-v2:9092
      - SERVER_PORT=8080
      - ENABLE_SCHEDULING=false
      - APP_FEATURE_REMOTE_RENDERING=false
      - APP_FEATURE_CONSUMER_SCRIPT=false
      - APP_FEATURE_CONSUMER_SCENE=true
      - APP_FEATURE_CONSUMER_RENDER=true
      - PYTHON_SERVICE_URL=http://shorts-ai-service-v2:8000
    volumes:
      - ./backend/client_secret:/app/client_secret
      - ./backend/tokens:/app/tokens
      - shorts-data-v2:/app/shared-data
    networks:
      - shorts-network-v2

  # ---------------------------------------------------------------------------
  # 5. AI MEDIA SERVICE (Python - V2)
  # ---------------------------------------------------------------------------
  shorts-ai-service-v2:
    build:
      context: ./backend/ai-media-service
      dockerfile: Dockerfile
    image: shorts-ai-service-v2:latest
    container_name: shorts-ai-service-v2
    ports:
      - "8001:8000"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    volumes:
      - shorts-data-v2:/app/shared-data
    networks:
      - shorts-network-v2

  # ---------------------------------------------------------------------------
  # 5. FRONTEND & GATEWAY
  # ---------------------------------------------------------------------------
  shorts-frontend-v2:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: shorts-frontend-v2:latest
    container_name: shorts-frontend-v2
    networks:
      - shorts-network-v2

  nginx-v2:
    image: nginx:latest
    container_name: nginx-v2
    ports:
      - "8090:80" # Unified Entry Point
    volumes:
      - ./nginx/nginx-v2.conf:/etc/nginx/nginx.conf
    networks:
      - shorts-network-v2
    depends_on:
      - shorts-frontend-v2
      - shorts-science-v2

volumes:
  mongo-data-v2:
  shorts-data-v2:


networks:
  shorts-network-v2:
    driver: bridge
